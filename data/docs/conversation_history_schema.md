# Conversation History Table Schema

## Table: conversation_history

The `conversation_history` table stores all chat interactions between users and the AI assistant, enabling conversation continuity and analytics on user interactions.

### Table Structure

| Column Name | Data Type | Description | Example Values |
|-------------|-----------|-------------|----------------|
| `id` | INTEGER | Primary key, auto-incrementing unique identifier | 1, 2, 3, ... |
| `conversation_id` | VARCHAR(255) | Unique identifier for the conversation session | "user_123_session_456", "support_ticket_789" |
| `message_type` | VARCHAR(50) | Type of message (user or assistant) | "user", "assistant" |
| `content` | TEXT | The actual message content | "Show me engagement metrics", "Here are the latest metrics..." |
| `timestamp` | DATETIME | When the message was sent/received (UTC) | "2024-06-07 14:30:00" |

## Message Types

### User Messages (`message_type = 'user'`)
Messages sent by users to the AI assistant.

**Characteristics:**
- Contain questions, requests, or commands
- May include specific metric names or categories
- Can reference previous conversation context
- Often contain natural language queries

**Common patterns:**
- Metric requests: "Show me revenue metrics for last month"
- Comparisons: "How does this compare to last quarter?"
- Explanations: "What does this metric mean?"
- Troubleshooting: "Why is the conversion rate dropping?"

### Assistant Messages (`message_type = 'assistant'`)
Responses generated by the AI assistant.

**Characteristics:**
- Contain answers, data, and explanations
- May include formatted metric data
- Often reference retrieved information from RAG
- Include contextual explanations and insights

**Response types:**
- Data responses: Formatted metric results with explanations
- Error messages: When queries cannot be processed
- Clarification requests: When user intent is unclear
- Guidance: Suggestions for better queries or next steps

## Conversation ID Patterns

### User Session IDs
Format: `user_{user_id}_session_{timestamp}`
- Example: `user_123_session_1686154800`
- Used for individual user chat sessions
- Enables tracking user behavior over time

### Support Ticket IDs
Format: `support_ticket_{ticket_id}`
- Example: `support_ticket_ST-2024-001`
- Links conversations to support cases
- Enables support team analytics

### Anonymous Sessions
Format: `anon_{random_id}`
- Example: `anon_a1b2c3d4e5f6`
- For users who don't want to authenticate
- Limited conversation history retention

## Data Retention Policies

### Active Conversations
- Conversations with activity in the last 30 days
- Full message history maintained
- Used for context in ongoing sessions

### Archived Conversations
- Conversations older than 30 days with no activity
- Compressed and moved to long-term storage
- Searchable for analytics but not used for context

### Analytics Data
- Aggregated conversation metrics retained indefinitely
- Individual messages anonymized after 1 year
- Used for system improvement and insights

## Privacy and Security

### Data Protection
- All message content is encrypted at rest
- Personal information is automatically detected and masked
- Users can request conversation deletion (GDPR compliance)

### Access Controls
- Conversations are isolated by user/session
- Support staff can only access conversations with explicit permission
- Audit logs track all conversation access

## Common Queries

### Get recent conversation history
```sql
SELECT message_type, content, timestamp
FROM conversation_history 
WHERE conversation_id = 'user_123_session_456'
ORDER BY timestamp DESC
LIMIT 20;
```

### Analyze conversation patterns
```sql
SELECT 
  DATE(timestamp) as conversation_date,
  COUNT(*) as total_messages,
  COUNT(CASE WHEN message_type = 'user' THEN 1 END) as user_messages,
  COUNT(CASE WHEN message_type = 'assistant' THEN 1 END) as assistant_messages
FROM conversation_history 
WHERE timestamp >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(timestamp)
ORDER BY conversation_date;
```

### Find conversations about specific topics
```sql
SELECT DISTINCT conversation_id, timestamp
FROM conversation_history 
WHERE content LIKE '%engagement metrics%'
  AND message_type = 'user'
  AND timestamp >= DATE_SUB(NOW(), INTERVAL 30 DAY)
ORDER BY timestamp DESC;
```

## Integration with AI Assistant

### Context Window Management
- Recent messages (last 10-20) are included in AI context
- Older messages are summarized for context
- System maintains conversation flow and references

### Conversation Analytics
- Track user satisfaction through conversation patterns
- Identify common questions for documentation improvement
- Monitor assistant response quality and accuracy

### Personalization
- Learn user preferences from conversation history
- Adapt response style to user communication patterns
- Remember user-specific context and preferences 